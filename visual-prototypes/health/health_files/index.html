<!DOCTYPE html>
<!-- saved from url=(0124)https://www.ons.gov.uk/visualisations/dvc413/chart/stackedbar/index.html?initialWidth=700&childId=6bd-4c09-9aef-6a36238da71a -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="./css" rel="stylesheet" type="text/css">
<title></title>
<meta name="description" content="">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="./globalStyle.css">
<style type="text/css">
		body{
			max-width:800px;
			margin:0px auto;
		}
		
		.axis path {stroke:none !important;}
		
		.bar-0 { fill: #00A7A3; }
        .bar-1 { fill: #D0D2D3; }
        .bar-2 { fill: #f3942f; }
		.bar-3 { fill: #274796; }
		.bar-4 { fill: #979796; }

        .key-0 b {margin-top:0px !important; width: 15px !important; background-color: #00A7A3; }
        .key-1 b {margin-top:0px !important; width: 15px !important; background-color: #D0D2D3; }
        .key-2 b {margin-top:0px !important; width: 15px !important; background-color: #f3942f; }
		.key-3 b {margin-top:0px !important; width: 15px !important; background-color: #274796; }
		.key-4 b {margin-top:0px !important; width: 15px !important; background-color: #979796; }

.arrow-line {
			stroke:black;
		}

		#triangleEnd {
			fill:black;
		}

		#triangleStart {
			fill:black;
		}

		.altGapText0,.altGapText1,.altGapText2 { 
			font-size:13px;
			fill:#414042;
			font-family:"Open Sans",sans-serif;font-weight:500;
		}

		.altGapText2 {
			display:none;
		}

	
    </style>
</head>
<body marginheight="0" style="">
<div id="graphic"><ul class="key"><li class="key-0"><b></b><label>Healthy life expectancy</label></li><li class="key-1"><b></b><label>Life expectancy</label></li></ul><svg width="700" height="274"><g transform="translate(60,20)"><g class="y axis" transform="translate(0,219)"><g class="tick major" transform="translate(0,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">0</text></g><g class="tick major" transform="translate(69,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">10</text></g><g class="tick major" transform="translate(139,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">20</text></g><g class="tick major" transform="translate(208,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">30</text></g><g class="tick major" transform="translate(278,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">40</text></g><g class="tick major" transform="translate(347,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">50</text></g><g class="tick major" transform="translate(417,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">60</text></g><g class="tick major" transform="translate(486,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">70</text></g><g class="tick major" transform="translate(556,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">80</text></g><g class="tick major" transform="translate(625,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">90</text></g><path class="domain" d="M0,6V0H625V6"></path></g><g class="x axis"><g class="tick major" transform="translate(0,58)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-11" y="0" dy=".32em" style="text-anchor: end;">Males</text></g><g class="tick major" transform="translate(0,162)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-11" y="0" dy=".32em" style="text-anchor: end;">Females</text></g><path class="domain" d="M-6,0H0V219H-6"></path><text y="242" x="625" dy=".71em" style="text-anchor: end;">years</text></g><g class="x grid"><g class="tick major" transform="translate(0,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(69,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(139,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(208,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(278,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(347,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(417,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(486,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(556,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><g class="tick major" transform="translate(625,0)" style="opacity: 1;"><line y2="219" x2="0"></line><text y="222" x="0" dy=".71em" style="text-anchor: middle;"></text></g><path class="domain" d="M0,0V0H625V0"></path></g><g class="g bars" transform="translate(0,11)"><rect class="bar-0" height="94" x="0" width="438" style="opacity: 0.85;"></rect><rect class="bar-1" height="94" x="438" width="118" style="opacity: 0.85;"></rect><text></text></g><g class="g bars" transform="translate(0,115)"><rect class="bar-0" height="94" x="0" width="444" style="opacity: 0.85;"></rect><rect class="bar-1" height="94" x="444" width="132" style="opacity: 0.85;"></rect><text></text></g><defs><marker id="triangleStart" viewBox="0 0 20 20" refX="0" refY="5" markerUnits="strokeWidth" markerWidth="20" markerHeight="20" orient="auto"><path d="M 0 5 L 10 10 L 10 0 z"></path></marker></defs><defs><marker id="triangleEnd" viewBox="0 0 20 20" refX="10" refY="5" markerUnits="strokeWidth" markerWidth="20" markerHeight="20" orient="auto"><path d="M 10 5 L 0 0 L 0 10 z"></path></marker></defs><text class="annotext0" text-anchor="middle" y="11" x="497" transform="translate(0 , 32.9)"><tspan>Poorer</tspan><tspan x="497" dy="22">health</tspan></text><line class="arrow-line" x1="438" x2="556" y1="11" y2="11" transform="translate(0 , 75.2)" marker-end="url(#triangleEnd)" marker-start="url(#triangleStart)"></line><text class="annotext1" text-anchor="middle" y="115" x="510" transform="translate(0 , 32.9)"><tspan>Poorer</tspan><tspan x="510" dy="22">health</tspan></text><line class="arrow-line" x1="444" x2="576" y1="115" y2="115" transform="translate(0 , 75.2)" marker-end="url(#triangleEnd)" marker-start="url(#triangleStart)"></line></g></svg></div>
<div id="keypoints"></div>
<div class="footer"><p>Source: <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/healthandlifeexpectancies/bulletins/healthstatelifeexpectanciesuk/2013to2015" target="_blank">Health state life expectancies</a></p></div>
<script src="./jquery.js" type="text/javascript"></script>
<script src="./d3.v3.min.js" type="text/javascript"></script>
<script src="./modernizr.svg.min.js" type="text/javascript"></script>
<script src="./pym.js" type="text/javascript"></script>
<script>
	
var graphic = $('#graphic');
var keypoints = $('#keypoints');
var footer = $(".footer");
var pymChild = null;
var pymChild = null;



function drawGraphic(width) {
	var threshold_md = 788;
	var threshold_sm = dvc.optional.mobileBreakpoint; 

	
	if (graphic.width() < threshold_sm) {        	
			var margin = {top: dvc.optional.margin_sm[0], right: dvc.optional.margin_sm[1], bottom: dvc.optional.margin_sm[2], left: dvc.optional.margin_sm[3]}; 
			var chart_width = graphic.width() - margin.left - margin.right;
			var height = Math.ceil((chart_width * dvc.optional.aspectRatio_sm[1]) / dvc.optional.aspectRatio_sm[0]) - margin.top - margin.bottom;
	} else if (graphic.width() < threshold_md){
			var margin = {top: dvc.optional.margin_md[0], right: dvc.optional.margin_md[1], bottom: dvc.optional.margin_md[2], left: dvc.optional.margin_md[3]}; 
			var chart_width = graphic.width() - margin.left - margin.right;
			var height = Math.ceil((chart_width * dvc.optional.aspectRatio_md[1]) / dvc.optional.aspectRatio_md[0]) - margin.top - margin.bottom;
	} else {
			var margin = {top: dvc.optional.margin_lg[0], right: dvc.optional.margin_lg[1], bottom: dvc.optional.margin_lg[2], left: dvc.optional.margin_lg[3]}
			var chart_width = graphic.width() - margin.left - margin.right;
			var height = Math.ceil((chart_width * dvc.optional.aspectRatio_lg[1]) / dvc.optional.aspectRatio_lg[0]) - margin.top - margin.bottom;
	}

	// clear out existing graphics
	graphic.empty();
	keypoints.empty();
	footer.empty();
			
	
	 y = d3.scale.ordinal()
		.rangeRoundBands([0, height], .1);
	
	 x = d3.scale.linear()
		.rangeRound([0,chart_width]);
		
	
		
    var formatAsPercentage = d3.formatPrefix('%',0);
	
    y.domain(d3.extent(graphic_data, function(d) { return d.cat; }));	

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(function(d,i) {
			return d
        })
		.tickPadding(5);


	d3.selectAll(".tick").selectAll("line").attr("transform", "translate(30,0)");

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient('bottom')

	if (graphic.width() <= threshold_sm) {
			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[0])
		 } else if (graphic.width() <= threshold_md){
			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[1])
		 } else {
			xAxis.ticks(dvc.optional.x_num_ticks_sm_md_lg[2])
		 }


    var x_axis_grid = function() { return xAxis; }

	var legend = d3.select('#graphic').append('ul')
					.attr('class', 'key')
					.selectAll('g')
					.data(dvc.essential.legendLabels)
					.enter().append('li')
					.attr("class",function(d,i){return "key-" + i})

	legend.append('b')
	legend.append('label')
		.html(function(d,i) { return dvc.essential.legendLabels[i]; });

    var svg = d3.select('#graphic').append('svg')
        .attr("width", chart_width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	y.domain(graphic_data.map(function(d) { 
		return d.cat;
	}));
	
	//y domain calculations	: zero to intelligent max choice, or intelligent min and max choice,  or interval chosen manually
	if (dvc.essential.xAxisScale == "auto_zero_max"){
	   var xDomain = [
						0,Math.ceil(d3.max(dvc.rows))
					 ];
	} else if (dvc.essential.xAxisScale == "auto_min_max"){
		console.log("not appropriate for a stack bar chart");
	} else {
	   var xDomain = dvc.essential.xAxisScale;
	}
	
	x.domain(xDomain);


    svg.append('g')
        .attr('class', 'y axis')
        .attr('transform', 'translate(0,' + (height*1.00) + ')')
        .call(xAxis);

    svg.append('g')
        .attr('class', 'x axis')
        .call(yAxis)
	 .append("text")
		 .attr("y", height+23)
		 .attr("x",chart_width)
		 .attr("dy", ".71em")
		 .style("text-anchor", "end")
		 .text(dvc.essential.yAxisLabel);

    svg.append('g')
        .attr('class', 'x grid')
        .call(x_axis_grid()
            .tickSize(height, 0)
            .tickFormat('')
        );

	
    var group = svg.selectAll(".year")
      .data(graphic_data)
	  .enter().append("g")
      .attr("class", "g bars")
      .attr("transform", function(d) { return "translate(0," + y(d.cat) + ")"; });

	group.selectAll("rect")
      .data(function(d) { return d.vars; })
      .enter().append("rect")
	  .attr("class",function(d,i){return "bar-" + i})
      .attr("height", y.rangeBand())
	  .attr("x", function(d) { 
	  console.log("0 " + d.x1);
			if (d.x1 >=0){
				return x(d.x0);
			} else {
				return x(d.x2)+ (x(d.x0) - x(d.x1));
			}	  
			})
	  .attr("width", function(d) { 
	  			console.log("0 " + d.x0);
			if (d.x1 >=0){
				return Math.abs(x(d.x0) - x(d.x1));
			} else {
				return Math.abs(x(d.x0) - x(d.x1));

			}
	  })
	  .style("opacity", 0.85)
	
		group.append("text").text(function(d){ console.log(d); return d.x0;});

	 

	  svg.append("defs").append("marker")
								.attr("id","triangleStart")
				                .attr("viewBox", "0 0 20 20")
				                .attr("refX", 0)
				                .attr("refY", 5)
				                .attr("markerUnits", "strokeWidth")
				                .attr("markerWidth", 20)
				                .attr("markerHeight", 20)
				                .attr("orient", "auto")
				                .append("path")
				                .attr("d", "M 0 5 L 10 10 L 10 0 z");						
	
			svg.append("defs").append("marker")
								.attr("id","triangleEnd")
				                .attr("viewBox", "0 0 20 20")
				                .attr("refX", 10)
				                .attr("refY", 5)
				                .attr("markerUnits", "strokeWidth")
				                .attr("markerWidth", 20)
				                .attr("markerHeight", 20)
				                .attr("orient", "auto")
				                .append("path")
				                .attr("d", "M 10 5 L 0 0 L 0 10 z");	

		
		writeAnnotation();
			

            
			function writeAnnotation(){
		
			// if (graphic.width() < threshold_sm) {
				
			// 		dvc.essential.annotationBullet.forEach(function(d,i) {
					
			// 			/*d3.select("#keypoints").append("svg")
			// 				.attr("width","20px")
			// 				.attr("height","20px")
			// 				.attr("class","circles")
			// 				.append("circle")
			// 				.attr("class", "annocirc" + (i))
			// 				.attr("r", "2")
			// 				.attr('cy',"12px")
			// 				.attr("cx", "10px");
						
				
			// */

			// 			d3.select("#keypoints").append("p").text(dvc.essential.annotationBullet[i]);
					
			// 		})// end foreach

			// 		dvc.essential.annotationChart.forEach(function(d,i) {
			// 			svg.append("line")
			// 					  	.attr("x1",function(d) { return x(dvc.essential.lineX_1_2[i][0]); })
			// 					  	.attr("x2", function(d) { return x(dvc.essential.lineX_1_2[i][1]); })
			// 					  	.attr("y1", function(d) { return y(dvc.essential.annotationXY[i][1]) })
			// 					  	.attr("y2", function(d) { return y(dvc.essential.annotationXY[i][1]) })
			// 					  	.attr("transform", "translate(0 , "+ y.rangeBand()*0.85 + ")" )
			// 					  	.attr("marker-end",  "url(#triangleEnd)")
			// 					  	.attr("marker-start",  "url(#triangleStart)");

			// 			svg.append("text")
			// 						.attr("class", "altGapText"+i)
			// 						.attr("text-anchor", dvc.essential.annotationAlign[i])
			// 						.attr('y',y(dvc.essential.annotationXY[i][1]))						
			// 						.attr('x',x(dvc.essential.annotationXY[i][0]))
			// 						.text(dvc.essential.annotationChart[i])
			// 						.attr("transform", "translate(-15 , "+ y.rangeBand()*0.60 + ")" );




			// 		})// end foreach
			// }		
			// else {
					
						dvc.essential.annotationChart.forEach(function(d,i) {
												
							// draw annotation text based on content of var annotationArray ...	
							svg.append("text")
								.text(dvc.essential.annotationChart[i])
								.attr("class","annotext" + i)
								.attr("text-anchor", dvc.essential.annotationAlign[i])
								.attr('y',y(dvc.essential.annotationXY[i][1]))						
								.attr('x',x(dvc.essential.annotationXY[i][0]));
										
							d3.selectAll(".annotext" + (i))
								.each(insertLinebreaks)
								//.each(createBackRect);	
								
								
							function insertLinebreaks() {
								
								var str = this;
			
								var el1 = dvc.essential.annotationChart[i];
								var el = el1.data;
						
								var words = el1.split('  ');
								
								d3.select(this).text('').attr("transform", "translate(0 , "+ y.rangeBand()*0.35 + ")" );
							
								for (var j = 0; j < words.length; j++) {
									var tspan = d3.select(this).append('tspan').text(words[j]);
									if (j > 0)
										tspan.attr('x', x/*0*/(/*d3.time.format(dvc.essential.dateFormat).parse(*/dvc.essential.annotationXY[i][0]/*)*/)).attr('dy', '22');													
								}
							};					
													
							function createBackRect() {
								
							var BBox = this.getBBox()
											
									svg.insert("rect", ".annotext" + (i))
										.attr("width", BBox.width)
										.attr("height", BBox.height)
										.attr("x", BBox.x)
										.attr("y", BBox.y)
										.attr("id", "annorect"+ (i))
										.attr("fill", "white")
										.attr("opacity", 0.4)
										.attr("transform", "translate(0 , "+ y.rangeBand()*0.45 + ")" );
										
							}; // end function createBackRect()
						
						
							// draw circles, if var 'dvc.essential.circles' is set to true
							if ( dvc.essential.circles == true ) {
								
								svg.append("circle")
									.attr("class", "annocirc" + (i))
									.attr('cy',y(dvc.essential.annotationCXCY[i][1]))
									.attr('cx',x(d3.time.format(dvc.essential.dateFormat).parse(dvc.essential.annotationCXCY[i][0])))
									.attr("r", "3");
								
							} // end if ... 

							svg.append("line")
								.attr("class", "arrow-line")
							  	.attr("x1",function(d) { return x(dvc.essential.lineX_1_2[i][0]); })
							  	.attr("x2", function(d) { return x(dvc.essential.lineX_1_2[i][1]); })
							  	.attr("y1", function(d) { return y(dvc.essential.annotationXY[i][1]) })
							  	.attr("y2", function(d) { return y(dvc.essential.annotationXY[i][1]) })
							  	.attr("transform", "translate(0 , "+ y.rangeBand()*0.80 + ")" )
							  	.attr("marker-end",  "url(#triangleEnd)")
							  	.attr("marker-start",  "url(#triangleStart)");
									
							d3.select(".annotext2").attr("transform", "translate(0 , "+ y.rangeBand()*0.7 + ")" );
							d3.select("#annorect2").attr("transform", "translate(0 , "+ y.rangeBand()*0.7 + ")" );
							

														
		   					
	


						});	// end foreach 		
					
				// } // end else ...  

				return;
				
			}// end function writeAnnotation()
							
		
			var xticks = svg.selectAll('#xAxis').selectAll('.tick');	
			xticks.append('svg:line')
				.attr( 'class' , "tick" )
				.attr( 'y1' , 0 )
				.attr( 'y2' , -height )
				.attr( 'x0' , 0 )
				.attr( 'x1',  0 );
	
	
	
		//create link to source				
		d3.select(".footer").append("p")
			.text("Source: ")
			.append("a")
			.attr("href", dvc.essential.sourceURL)
			.attr("target", "_blank")
			.html(dvc.essential.sourceText);


    if (chart_width > dvc.optional.mobileBreakpoint) {
	} else {

	}
		
    if (pymChild) {
        pymChild.sendHeight();
    }
}


	if (Modernizr.svg) {

		d3.json("config.json", function(error, config) {
		dvc=config
			

		  		
			d3.csv(dvc.essential.graphic_data_url, function(error, data) {
				graphic_data = data;
				varnames = d3.keys(graphic_data[0]).filter(function(key) { return key !== "group";});
				
				graphic_data.forEach(function(d) {
				
					d.cat = d.group;
					
					var x0 = 0;
					d.vars = varnames.map(function(name){ return {
								name: name, 
								x0: x0, 
								x1: x0 += +d[name],
								x2: d[name]
							}; 
					 });
																		
					d.total = d.vars[d.vars.length - 1].y1;
				});
		
				// Cycle through data and sum all data for all data columns
				d3.csv(dvc.essential.graphic_data_url).row(function(d) { 
							  var mySum = 0;
							  for (var o in d) { // iterate all the properties of d
								  if (o === "group") continue; // if it's our key field skip it
								  else mySum += +d[o]; // everyone else into the sum
								}
								return mySum
						  
						   })
						 .get(function(error, rows) { 
							dvc.rows=rows;
							pymChild = new pym.Child({ renderCallback: drawGraphic});
						  });
				
			});
			
			
		
	});
	
	} else {
		 pymChild = new pym.Child();
		if (pymChild) {
			pymChild.sendHeight();
		}
	}

	
    </script>


</body></html>